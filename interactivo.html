<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba de Habilidad de Teclado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Un gris azulado claro */
            display: flex;
            justify-content: center;
            align-items: center; 
            min-height: 100vh;
            margin: 0;
            overflow: hidden; /* Evitar scroll si el mensaje de prohibido mouse aparece */
        }
        .container {
            background-color: #ffffff; /* Blanco */
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            position: relative;
        }
        .mouse-blocker {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 0, 0, 0.85); /* Rojo semi-transparente */
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            z-index: 1000;
            cursor: not-allowed;
            backdrop-filter: blur(5px);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .mouse-blocker.active {
            opacity: 1;
            visibility: visible;
        }
        .input-area, .output-area {
            min-height: 100px;
            border: 2px solid #cbd5e1; /* Gris claro */
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #f8fafc; /* Blanco muy claro */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            resize: vertical;
        }
        .input-area:focus, .output-area:focus {
            outline: none;
            border-color: #6366f1; /* Indigo 500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3); /* Sombra para enfoque */
        }
        .button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .button-primary {
            background-color: #6366f1; /* Indigo 500 */
            color: white;
        }
        .button-primary:hover {
            background-color: #4f46e5; /* Indigo 600 */
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .button-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .button-secondary { /* These buttons will be hidden or used for restart now */
            background-color: #e2e8f0; /* Gris 200 */
            color: #475569; /* Gris 600 */
        }
        .button-secondary:hover {
            background-color: #cbd5e1; /* Gris 300 */
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .button-secondary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .feedback-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
        }
        .feedback-success {
            background-color: #d1fae5; /* Verde claro */
            color: #065f46; /* Verde oscuro */
        }
        .feedback-error {
            background-color: #fee2e2; /* Rojo claro */
            color: #991b1b; /* Rojo oscuro */
        }
        .task-section {
            display: none;
        }
        .task-section.active {
            display: block;
        }
        .shortcut-tip {
            background-color: #eff6ff;
            border-left: 4px solid #60a5fa;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #1e3a8a;
        }
        /* Estilos para simular formato de Word */
        .formatted-text-area {
            border: 2px solid #cbd5e1;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #f8fafc;
            min-height: 150px;
            font-size: 1rem;
            color: #333;
            line-height: 1.5;
            transition: all 0.2s ease-in-out;
        }
        /* Clases para aplicar estilos con JS */
        .formatted-text-area.bold { font-weight: bold; }
        .formatted-text-area.italic { font-style: italic; }
        .formatted-text-area.underline { text-decoration: underline; }
        .formatted-text-area.font-arial { font-family: Arial, sans-serif; }
        .formatted-text-area.font-courier-new { font-family: 'Courier New', monospace; }
        .formatted-text-area.font-times-new-roman { font-family: 'Times New Roman', serif; }
        .formatted-text-area.size-small { font-size: 0.8rem; }
        .formatted-text-area.size-medium { font-size: 1rem; }
        .formatted-text-area.size-large { font-size: 1.2rem; }
        .formatted-text-area.color-red { color: #dc2626; }
        .formatted-text-area.color-blue { color: #2563eb; }
        .formatted-text-area.color-green { color: #059669; }
        .formatted-text-area.justify-left { text-align: left; }
        .formatted-text-area.justify-center { text-align: center; }
        .formatted-text-area.justify-right { text-align: right; }
        .formatted-text-area.justify-full { text-align: justify; }

        .navigation-highlight {
            background-color: yellow;
            font-weight: bold;
        }
        /* Estilos para el mensaje de avance autom√°tico */
        .auto-advance-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 128, 0, 0.9); /* Green */
            color: white;
            padding: 2rem 4rem;
            border-radius: 1rem;
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .auto-advance-message.active {
            opacity: 1;
            visibility: visible;
        }
        /* Hide buttons that are now auto-advanced */
        .hidden-button {
            display: none !important;
        }
        /* Styles for the formatting status panel */
        .format-status-panel {
            background-color: #ecf0f3;
            border: 1px solid #dcdfe3;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }
        .format-status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: #f8fafc;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: #475569;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        }
        .format-status-label {
            color: #2d3748;
            font-weight: 600;
        }
        .format-status-value {
            color: #6366f1; /* Indigo 500 */
            font-weight: 700;
        }
        .format-status-value.on {
            color: #059669; /* Green for ON */
        }
        .format-status-value.off {
            color: #dc2626; /* Red for OFF */
        }

        /* Styles for Quiz */
        .quiz-option-button {
            background-color: #e2e8f0;
            color: #475569;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            outline: none; /* Hide default focus outline */
        }
        .quiz-option-button:hover {
            background-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .quiz-option-button:focus {
            border: 2px solid #6366f1; /* Blue border on focus */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }
        .quiz-option-button.correct {
            background-color: #a7f3d0; /* Green light */
            color: #065f46; /* Green dark */
        }
        .quiz-option-button.incorrect {
            background-color: #fecaca; /* Red light */
            color: #991b1b; /* Red dark */
        }
    </style>
</head>
<body>
    <div class="mouse-blocker" id="mouseBlocker">
        ¬°PROHIBIDO EL USO DEL RAT√ìN! üñ±Ô∏èüö´
    </div>

    <div class="container">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Prueba de Habilidad de Teclado üöÄ</h1>

        <!-- Introducci√≥n -->
        <div id="intro-section" class="task-section active">
            <p class="text-gray-700 text-lg mb-4 text-center">
                Bienvenido a la prueba de habilidad de teclado. Prep√°rate para demostrar tu dominio del teclado.
                ¬°Recuerda, <strong>no se permite el uso del rat√≥n</strong> durante la prueba! El mensaje de advertencia se ir√° autom√°ticamente cuando dejes de mover el rat√≥n y uses solo el teclado.
                Todas las fases avanzar√°n autom√°ticamente una vez completadas. ü§´
            </p>
            <div class="flex justify-center">
                <button id="startTestBtn" class="button button-primary">Comenzar Prueba</button>
            </div>
        </div>

        <!-- Fase 1.1: Ingreso de Palabra Simple -->
        <div id="phase1-1" class="task-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">Fase 1.1: Ingreso de Palabra Simple</h2>
            <p class="text-gray-600 mb-2">Escribe la siguiente palabra (sin may√∫sculas ni acentos):</p>
            <div class="text-center mb-4">
                <span id="wordToType" class="text-4xl font-bold text-indigo-700"></span>
            </div>
            <input type="text" id="wordInput" class="input-area w-full text-lg" placeholder="Escribe aqu√≠ la palabra..." autocomplete="off">
            <div id="wordFeedback" class="feedback-message hidden"></div>
            <p id="wordTime" class="text-gray-600 text-center mt-2 hidden">Tiempo: <span class="font-bold">0.00s</span></p>
            <div class="flex justify-center mt-4">
                <button id="nextPhase1-1Btn" class="button button-primary hidden-button" disabled>Siguiente Fase</button>
            </div>
        </div>

        <!-- Fase 1.2: Acentos y Combinaciones ALT -->
        <div id="phase1-2" class="task-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">Fase 1.2: Acentos y Combinaciones ALT</h2>
            <p class="text-gray-600 mb-2">Escribe la siguiente palabra exactamente como aparece (incluyendo acentos y may√∫sculas si las hay):</p>
            <div class="shortcut-tip mt-2 mb-4">
                <strong>Tips para Acentos (NumPad):</strong>
                <p><kbd>Alt</kbd> + <kbd>160</kbd> = √° | <kbd>Alt</kbd> + <kbd>130</kbd> = √© | <kbd>Alt</kbd> + <kbd>161</kbd> = √≠ | <kbd>Alt</kbd> + <kbd>162</kbd> = √≥ | <kbd>Alt</kbd> + <kbd>163</kbd> = √∫</p>
                <p><kbd>Alt</kbd> + <kbd>165</kbd> = √ë | <kbd>Alt</kbd> + <kbd>164</kbd> = √±</p>
                <p>Aseg√∫rate de usar el teclado num√©rico (NumPad) si tu teclado lo tiene, con Num Lock activado.</p>
            </div>
            <div class="text-center mb-4">
                <span id="wordToTypeAccented" class="text-4xl font-bold text-indigo-700"></span>
            </div>
            <input type="text" id="wordInputAccented" class="input-area w-full text-lg" placeholder="Escribe aqu√≠ la palabra con acentos..." autocomplete="off">
            <div id="wordAccentedFeedback" class="feedback-message hidden"></div>
            <p id="wordAccentedTime" class="text-gray-600 text-center mt-2 hidden">Tiempo: <span class="font-bold">0.00s</span></p>
            <div class="flex justify-center mt-4">
                <button id="nextPhase1-2Btn" class="button button-primary hidden-button" disabled>Siguiente Fase</button>
            </div>
        </div>

        <!-- Fase 2: Copiar, Cortar, Pegar -->
        <div id="phase2" class="task-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">Fase 2: Copiar, Cortar y Pegar</h2>
            <p class="text-gray-600 mb-2">Realiza las siguientes tareas usando <strong>solo el teclado</strong>.
                Puedes navegar entre las √°reas de texto usando <kbd>Tab</kbd> o <kbd>Shift</kbd> + <kbd>Tab</kbd>.</p>

            <!-- Tarea 2.1: Copiar y Pegar P√°rrafo Completo -->
            <div id="task2-1" class="mb-6">
                <h3 class="text-xl font-medium text-gray-700 mb-2">Tarea 2.1: Copiar y Pegar (P√°rrafo Completo)</h3>
                <p class="text-gray-600 mb-2">Copia el siguiente p√°rrafo y p√©galo en el √°rea de texto de abajo:</p>
                <div id="paragraphSource1" class="input-area overflow-auto select-all" tabindex="0" contenteditable="true">
                    Este es el primer p√°rrafo de prueba. Es fundamental practicar las combinaciones de teclas
                    para mejorar la eficiencia en el manejo de documentos. La pr√°ctica constante lleva a la maestr√≠a.
                </div>
                <div class="shortcut-tip mt-2">
                    <strong>Tip:</strong> Para seleccionar todo: <kbd>Ctrl</kbd> + <kbd>A</kbd>. Para copiar: <kbd>Ctrl</kbd> + <kbd>C</kbd>. Para pegar: <kbd>Ctrl</kbd> + <kbd>V</kbd>.
                    Para navegar entre √°reas de texto: <kbd>Tab</kbd> o <kbd>Shift</kbd> + <kbd>Tab</kbd>.
                </div>
                <textarea id="paragraphTarget1" class="output-area w-full mt-2" placeholder="Pega el p√°rrafo aqu√≠..."></textarea>
                <div id="copyPasteFeedback1" class="feedback-message hidden"></div>
            </div>

            <!-- Tarea 2.2: Copiar y Pegar Parte del P√°rrafo -->
            <div id="task2-2" class="mb-6 hidden">
                <h3 class="text-xl font-medium text-gray-700 mb-2">Tarea 2.2: Copiar y Pegar (Parte del P√°rrafo)</h3>
                <p class="text-gray-600 mb-2">Copia solo la frase "<strong>La pr√°ctica constante lleva a la maestr√≠a.</strong>"
                    del siguiente p√°rrafo y p√©gala en el √°rea de texto de abajo:</p>
                <div id="paragraphSource2" class="input-area overflow-auto select-text" tabindex="0" contenteditable="true">
                    Para esta segunda tarea, conc√©ntrate en la selecci√≥n precisa. La pr√°ctica constante lleva a la maestr√≠a.
                    Dominar la selecci√≥n con el teclado es una habilidad clave.
                </div>
                <div class="shortcut-tip mt-2">
                    <strong>Tip:</strong> Usa <kbd>Shift</kbd> + <kbd>Flechas</kbd> para seleccionar.
                    Para navegar entre √°reas de texto: <kbd>Tab</kbd> o <kbd>Shift</kbd> + <kbd>Tab</kbd>.
                </div>
                <textarea id="paragraphTarget2" class="output-area w-full mt-2" placeholder="Pega la frase aqu√≠..."></textarea>
                <div id="copyPasteFeedback2" class="feedback-message hidden"></div>
            </div>

            <!-- Tarea 2.3: Cortar y Pegar Parte del P√°rrafo -->
            <div id="task2-3" class="mb-6 hidden">
                <h3 class="text-xl font-medium text-gray-700 mb-2">Tarea 2.3: Cortar y Pegar (Parte del P√°rrafo)</h3>
                <p class="text-gray-600 mb-2">Corta solo la frase "<strong>habilidades de edici√≥n avanzadas.</strong>"
                    del siguiente p√°rrafo y p√©gala en el √°rea de texto de abajo:</p>
                <div id="paragraphSource3" class="input-area overflow-auto select-text" tabindex="0" contenteditable="true">
                    Esta es la √∫ltima tarea de copiar/cortar/pegar. Necesitar√°s habilidades de edici√≥n avanzadas.
                    Aseg√∫rate de cortar la frase correcta.
                </div>
                <div class="shortcut-tip mt-2">
                    <strong>Tip:</strong> Para cortar: <kbd>Ctrl</kbd> + <kbd>X</kbd>.
                    Para navegar entre √°reas de texto: <kbd>Tab</kbd> o <kbd>Shift</kbd> + <kbd>Tab</kbd>.
                </div>
                <textarea id="paragraphTarget3" class="output-area w-full mt-2" placeholder="Pega la frase aqu√≠..."></textarea>
                <div id="cutPasteFeedback3" class="feedback-message hidden"></div>
            </div>

            <div class="flex justify-center mt-6">
                <button id="nextPhase2Btn" class="button button-primary hidden-button" disabled>Siguiente Fase</button>
            </div>
        </div>

        <!-- Fase 3: Formato de Texto (Simulaci√≥n Word) -->
        <div id="phase3" class="task-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">Fase 3: Formato de Texto (Accesos Directos Word)</h2>
            <p class="text-gray-600 mb-2">
                Aplica los siguientes formatos al texto de abajo usando los accesos directos de teclado de Microsoft Word.
                <strong>Navega al √°rea de texto usando <kbd>Tab</kbd> o <kbd>Shift</kbd> + <kbd>Tab</kbd>, y luego usa solo el teclado.</strong>
                Los formatos de <strong>Negrita, Cursiva y Subrayado</strong> se aplican a la selecci√≥n actual o a la palabra donde est√© el cursor.
                Los formatos de <strong>Fuente, Tama√±o, Color y Alineaci√≥n</strong> se aplican a todo el p√°rrafo (simulado).
                Observa c√≥mo cambian los formatos y el estado en el panel de control.
            </p>
            <div id="textToFormat" class="formatted-text-area" contenteditable="true" tabindex="0">
                Este es un p√°rrafo de ejemplo para practicar el formato de texto. Utiliza los atajos de teclado
                para cambiar su apariencia, tama√±o, color y alineaci√≥n. ¬°Demuestra tu habilidad!
            </div>

            <!-- Panel de Estado de Formato -->
            <div class="format-status-panel">
                <div class="format-status-item">
                    <span class="format-status-label">Negrita:</span>
                    <span id="statusBold" class="format-status-value off">DESACTIVADO</span>
                </div>
                <div class="format-status-item">
                    <span class="format-status-label">Cursiva:</span>
                    <span id="statusItalic" class="format-status-value off">DESACTIVADO</span>
                </div>
                <div class="format-status-item">
                    <span class="format-status-label">Subrayado:</span>
                    <span id="statusUnderline" class="format-status-value off">DESACTIVADO</span>
                </div>
                <div class="format-status-item">
                    <span class="format-status-label">Fuente:</span>
                    <span id="statusFont" class="format-status-value">Inter</span>
                </div>
                <div class="format-status-item">
                    <span class="format-status-label">Tama√±o:</span>
                    <span id="statusSize" class="format-status-value">Medio</span>
                </div>
                <div class="format-status-item">
                    <span class="format-status-label">Color:</span>
                    <span id="statusColor" class="format-status-value">Predeterminado</span>
                </div>
                <div class="format-status-item">
                    <span class="format-status-label">Alineaci√≥n:</span>
                    <span id="statusAlign" class="format-status-value">Izquierda</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                <div class="border p-4 rounded-lg bg-gray-50">
                    <h4 class="font-semibold mb-2">Formato B√°sico:</h4>
                    <ul>
                        <li><strong>Negrita:</strong> <kbd>Ctrl</kbd> + <kbd>N</kbd></li>
                        <li><strong>Cursiva:</strong> <kbd>Ctrl</kbd> + <kbd>K</kbd></li>
                        <li><strong>Subrayado:</strong> <kbd>Ctrl</kbd> + <kbd>S</kbd></li>
                    </ul>
                </div>
                <div class="border p-4 rounded-lg bg-gray-50">
                    <h4 class="font-semibold mb-2">Fuente y Tama√±o:</h4>
                    <ul>
                        <li><strong>Cambiar Fuente:</strong> (Simulado) <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>F</kbd></li>
                        <li><strong>Aumentar Tama√±o:</strong> <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>&gt;</kbd></li>
                        <li><strong>Disminuir Tama√±o:</strong> <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>&lt;</kbd></li>
                    </ul>
                </div>
                <div class="border p-4 rounded-lg bg-gray-50">
                    <h4 class="font-semibold mb-2">Alineaci√≥n y Color:</h4>
                    <ul>
                        <li><strong>Izquierda:</strong> <kbd>Ctrl</kbd> + <kbd>Q</kbd></li>
                        <li><strong>Centrar:</strong> <kbd>Ctrl</kbd> + <kbd>T</kbd></li>
                        <li><strong>Derecha:</strong> <kbd>Ctrl</kbd> + <kbd>D</kbd></li>
                        <li><strong>Justificar:</strong> <kbd>Ctrl</kbd> + <kbd>J</kbd></li>
                        <li><strong>Cambiar Color:</strong> (Simulado) <kbd>Ctrl</kbd> + <kbd>Shift</kbd> + <kbd>C</kbd></li>
                    </ul>
                </div>
            </div>
            <div class="shortcut-tip mt-4">
                <strong>Nota:</strong> Algunos atajos de Word no se pueden replicar directamente en un navegador. Esta fase avanza autom√°ticamente cuando hayas utilizado <strong>todos</strong> los atajos de formato al menos una vez.
            </div>

            <div class="flex justify-center mt-6">
                <button id="nextPhase3Btn" class="button button-primary hidden-button" disabled>Siguiente Fase</button>
            </div>
        </div>

        <!-- Fase 4: Navegaci√≥n de Texto -->
        <div id="phase4" class="task-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">Fase 4: Navegaci√≥n de Texto</h2>
            <p class="text-gray-600 mb-2">
                Navega a la ubicaci√≥n indicada usando <strong>solo el teclado</strong>. El texto objetivo se resaltar√° cuando est√©s cerca.
                Cuando creas que has llegado a la palabra, presiona <kbd>Enter</kbd> para verificar y avanzar.
            </p>
            <div id="navigationText" class="input-area overflow-auto" contenteditable="true" tabindex="0">
                El futuro de la tecnolog√≠a es incierto pero promete grandes avances. La inteligencia artificial, por ejemplo, est√° transformando industrias enteras y redefiniendo el trabajo. Es importante considerar la <strong>√©tica</strong> en el desarrollo de estas nuevas herramientas. Adem√°s, la computaci√≥n cu√°ntica podr√≠a revolucionar la forma en que procesamos la informaci√≥n, abriendo puertas a soluciones que hoy parecen imposibles. La ciberseguridad tambi√©n se vuelve crucial en un mundo cada vez m√°s conectado, protegiendo nuestros datos y privacidad. El aprendizaje autom√°tico es otra √°rea de r√°pido crecimiento, con aplicaciones en medicina, finanzas y arte. Finalmente, la realidad virtual y aumentada ofrecen nuevas formas de interacci√≥n humana y experiencia inmersiva.
            </div>
            <p class="text-gray-600 mt-4 mb-2">Tarea: Ve al principio de la palabra "<strong>√©tica</strong>".</p>
            <div id="navFeedback" class="feedback-message hidden"></div>
            <div class="flex justify-center mt-4">
                <button id="nextPhase4Btn" class="button button-primary hidden-button" disabled>Siguiente Fase</button>
            </div>
        </div>

        <!-- Fase 5: Completar Frases (Palabras sueltas) -->
        <div id="phase5" class="task-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">Fase 5: Completar Frases (Palabras Sueltas)</h2>
            <p class="text-gray-600 mb-2">
                Completa la siguiente frase escribiendo la palabra que falta usando solo el teclado.
                Presiona <kbd>Enter</kbd> despu√©s de cada palabra. Ten en cuenta que algunas palabras pueden requerir may√∫sculas o acentos.
            </p>
            <div class="text-center text-lg mb-4">
                <span id="sentenceToComplete" class="text-gray-800"></span>
            </div>
            <input type="text" id="sentenceInput" class="input-area w-full text-lg" placeholder="Escribe aqu√≠ la palabra que falta..." autocomplete="off">
            <div id="sentenceFeedback" class="feedback-message hidden"></div>
            <div class="flex justify-center mt-4">
                <button id="nextPhase5Btn" class="button button-primary hidden-button" disabled>Siguiente Fase</button>
            </div>
        </div>

        <!-- Fase 6: Completar Frases Avanzadas (Puntuaci√≥n, May√∫sculas, Acentos) -->
        <div id="phase6" class="task-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">Fase 6: Frases Completas Avanzadas</h2>
            <p class="text-gray-600 mb-2">
                Completa la siguiente frase exactamente como se indica, prestando atenci√≥n a <strong>may√∫sculas, acentos y puntuaci√≥n</strong>.
                Presiona <kbd>Enter</kbd> cuando termines la frase.
            </p>
            <div class="shortcut-tip mt-2 mb-4">
                <strong>Tips para S√≠mbolos Especiales:</strong>
                <p><strong>Guion largo (‚Äî):</strong> <kbd>Alt</kbd> + <kbd>0151</kbd></p>
                <p><strong>Copyright (¬©):</strong> <kbd>Alt</kbd> + <kbd>0169</kbd></p>
                <p><strong>Euro (‚Ç¨):</strong> <kbd>Alt</kbd> + <kbd>0128</kbd></p>
            </div>
            <div class="text-center text-lg mb-4">
                <span id="sentenceToTypeAdvanced" class="text-gray-800 font-bold"></span>
            </div>
            <input type="text" id="sentenceInputAdvanced" class="input-area w-full text-lg" placeholder="Escribe la frase completa aqu√≠..." autocomplete="off">
            <div id="sentenceAdvancedFeedback" class="feedback-message hidden"></div>
            <div class="flex justify-center mt-4">
                <button id="nextPhase6Btn" class="button button-primary hidden-button" disabled>Siguiente Fase</button>
            </div>
        </div>

        <!-- Fase 7: Quiz de Atajos de Word -->
        <div id="phase7" class="task-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">Fase 7: Quiz de Atajos de Word</h2>
            <p class="text-gray-600 mb-4">
                Selecciona la opci√≥n correcta para el atajo de teclado descrito. Navega con <kbd>Tab</kbd> y selecciona con <kbd>Enter</kbd>.
            </p>
            <div class="quiz-question text-lg font-semibold text-gray-800 mb-4">
                <span id="quizQuestion"></span>
            </div>
            <div id="quizOptions" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <!-- Buttons will be dynamically generated here -->
            </div>
            <div id="quizFeedback" class="feedback-message hidden"></div>
            <div class="flex justify-center mt-4">
                <button id="nextPhase7Btn" class="button button-primary hidden-button" disabled>Siguiente Fase</button>
            </div>
        </div>

        <!-- Fin de la prueba -->
        <div id="end-section" class="task-section">
            <h2 class="text-3xl font-bold text-center text-green-700 mb-4">¬°Prueba Finalizada! üéâ</h2>
            <p class="text-gray-700 text-lg text-center">
                Has completado todas las fases de la prueba de habilidad de teclado. ¬°Excelente trabajo!
            </p>
            <div class="flex justify-center mt-6">
                <button id="restartTestBtn" class="button button-secondary">Reiniciar Prueba</button>
            </div>
        </div>
    </div>

    <script>
        // Helper function to normalize whitespace
        function normalizeWhitespace(text) {
            // Replace multiple whitespace characters (spaces, tabs, newlines) with a single space
            // Then trim leading/trailing spaces
            return text.replace(/\s+/g, ' ').trim();
        }

        // CHEATCODE PARA AVANZAR DE FASE (Ctrl + Alt + Shift + A)
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.altKey && e.shiftKey && e.key === 'A') {
                e.preventDefault(); // Prevenir el comportamiento predeterminado del navegador
                console.log("[CHEATCODE] Avanzando a la siguiente fase...");
                // Determinar la siguiente fase y llamarla
                if (currentPhaseIndex < phases.length - 1) { // Ensure there's a next phase
                    const nextPhaseBtnId = phases[currentPhaseIndex].querySelector('.button-primary.hidden-button')?.id;
                    if (nextPhaseBtnId) {
                        document.getElementById(nextPhaseBtnId).disabled = false; // Enable the button first
                        autoAdvanceToNextPhase(nextPhaseBtnId, 'CHEATCODE ACTIVADO: Avanzando...');
                    } else {
                         // Fallback if no specific next button, directly show next phase
                         showPhase(currentPhaseIndex + 1);
                         // Re-initialize the new phase if it's not the last one
                         if (currentPhaseIndex < phases.length -1) {
                            switch (currentPhaseIndex) { // After advancing, currentPhaseIndex is already incremented
                                case 1: startPhase1_1(); break;
                                case 2: startPhase1_2(); break;
                                case 3: startPhase2(); break;
                                case 4: startPhase3(); break;
                                case 5: startPhase4(); break;
                                case 6: startPhase5(); break;
                                case 7: startPhase6(); break;
                                case 8: startPhase7(); break;
                                // No default for end phase or intro
                            }
                         }
                    }

                } else {
                    console.log("[CHEATCODE] Ya est√°s en la √∫ltima fase.");
                    // If already at the last phase (end-section), restart
                    if (currentPhaseIndex === phases.length - 1) {
                         resetTest();
                         showPhase(0);
                    }
                }
            }
        });


        // BLOQUEO DE RAT√ìN
        const mouseBlocker = document.getElementById('mouseBlocker');
        let mouseTimer;
        let testStarted = false;
        const MOUSE_INACTIVITY_THRESHOLD = 1500; // milisegundos

        document.addEventListener('mousemove', () => {
            if (testStarted) {
                mouseBlocker.classList.add('active');
                document.body.style.overflow = 'hidden'; // Evitar scroll
                clearTimeout(mouseTimer); // Reiniciar el temporizador cada vez que se mueve el rat√≥n
                mouseTimer = setTimeout(() => {
                    mouseBlocker.classList.remove('active');
                    document.body.style.overflow = ''; // Restaurar scroll
                }, MOUSE_INACTIVITY_THRESHOLD);
            }
        });

        document.addEventListener('mousedown', (e) => {
            // Permitir clicks solo en el bot√≥n de inicio de prueba
            if (!testStarted && e.target.id === 'startTestBtn') {
                return;
            }
            if (testStarted) {
                mouseBlocker.classList.add('active');
                document.body.style.overflow = 'hidden';
                e.preventDefault(); // Prevenir interacciones por clic
                clearTimeout(mouseTimer); // Asegurarse de que el temporizador no desactive el bloqueador inmediatamente despu√©s de un click
                mouseTimer = setTimeout(() => {
                    mouseBlocker.classList.remove('active');
                    document.body.style.overflow = '';
                }, MOUSE_INACTIVITY_THRESHOLD);
            }
        });

        // Funci√≥n para mostrar un mensaje de avance autom√°tico y luego hacer clic en el bot√≥n de siguiente
        function autoAdvanceToNextPhase(nextButtonId, messageText, delay = 2000) {
            const nextButton = document.getElementById(nextButtonId);
            if (!nextButton) return;

            const autoAdvanceMessage = document.createElement('div');
            autoAdvanceMessage.classList.add('auto-advance-message');
            autoAdvanceMessage.textContent = messageText;
            document.body.appendChild(autoAdvanceMessage);

            // Fade in the message
            setTimeout(() => {
                autoAdvanceMessage.classList.add('active');
            }, 100);

            // Auto-click the next phase button after a delay
            setTimeout(() => {
                autoAdvanceMessage.classList.remove('active'); // Fade out
                setTimeout(() => {
                    autoAdvanceMessage.remove(); // Remove after fade out
                    nextButton.click(); // Programmatically click the button
                }, 500); // Wait for fade out to complete
            }, delay); // Show message for 'delay' seconds
        }

        // NAVEGACI√ìN ENTRE FASES
        const introSection = document.getElementById('intro-section');
        const phase1_1 = document.getElementById('phase1-1'); // Old Phase 1
        const phase1_2 = document.getElementById('phase1-2'); // New Accents Phase
        const phase2 = document.getElementById('phase2');
        const phase3 = document.getElementById('phase3');
        const phase4 = document.getElementById('phase4');
        const phase5 = document.getElementById('phase5');
        const phase6 = document.getElementById('phase6'); // New Advanced Sentences Phase
        const phase7 = document.getElementById('phase7'); // New Quiz Phase
        const endSection = document.getElementById('end-section');

        const startTestBtn = document.getElementById('startTestBtn');
        const nextPhase1_1Btn = document.getElementById('nextPhase1-1Btn');
        const nextPhase1_2Btn = document.getElementById('nextPhase1-2Btn');
        const nextPhase2Btn = document.getElementById('nextPhase2Btn');
        const nextPhase3Btn = document.getElementById('nextPhase3Btn');
        const nextPhase4Btn = document.getElementById('nextPhase4Btn');
        const nextPhase5Btn = document.getElementById('nextPhase5Btn');
        const nextPhase6Btn = document.getElementById('nextPhase6Btn');
        const nextPhase7Btn = document.getElementById('nextPhase7Btn');
        const restartTestBtn = document.getElementById('restartTestBtn');

        let currentPhaseIndex = 0;
        // Updated phases array to include new phases
        const phases = [introSection, phase1_1, phase1_2, phase2, phase3, phase4, phase5, phase6, phase7, endSection];

        function showPhase(phaseIndex) {
            console.log(`[showPhase] Changing phase to: ${phaseIndex}`);
            phases.forEach((phase, index) => {
                if (index === phaseIndex) {
                    phase.classList.add('active');
                } else {
                    phase.classList.remove('active');
                }
            });
            currentPhaseIndex = phaseIndex;
        }

        startTestBtn.addEventListener('click', () => {
            testStarted = true;
            clearTimeout(mouseTimer); // Clear any pending mouse timer
            mouseBlocker.classList.remove('active'); // Ensure blocker is off
            document.body.style.overflow = '';
            showPhase(1); // Muestra la Fase 1.1
            startPhase1_1();
        });

        nextPhase1_1Btn.addEventListener('click', () => {
            showPhase(2); // Muestra la Fase 1.2 (Acentos)
            startPhase1_2();
        });

        nextPhase1_2Btn.addEventListener('click', () => {
            showPhase(3); // Muestra la Fase 2
            startPhase2();
        });

        nextPhase2Btn.addEventListener('click', () => {
            showPhase(4); // Muestra la Fase 3
            startPhase3();
        });

        nextPhase3Btn.addEventListener('click', () => {
            showPhase(5); // Muestra la Fase 4
            startPhase4();
        });

        nextPhase4Btn.addEventListener('click', () => {
            showPhase(6); // Muestra la Fase 5
            startPhase5();
        });

        nextPhase5Btn.addEventListener('click', () => {
            showPhase(7); // Muestra la Fase 6 (Frases Avanzadas)
            startPhase6();
        });

        nextPhase6Btn.addEventListener('click', () => {
            showPhase(8); // Muestra la Fase 7 (Quiz de Atajos)
            startPhase7();
        });

        nextPhase7Btn.addEventListener('click', () => {
            testStarted = false; // Finaliza el monitoreo del rat√≥n
            showPhase(9); // Muestra la secci√≥n de fin de prueba
        });

        restartTestBtn.addEventListener('click', () => {
            resetTest();
            showPhase(0); // Vuelve a la introducci√≥n
        });

        function resetTest() {
            console.log("[resetTest] Resetting all phases.");
            // Resetear Fase 1.1
            wordInput.value = '';
            wordFeedback.classList.add('hidden');
            wordTime.classList.add('hidden');
            wordInput.disabled = false; // Habilitar input
            currentWordIndex_1_1 = 0; // Reiniciar √≠ndice de palabras

            // Resetear Fase 1.2 (Acentos)
            wordInputAccented.value = '';
            wordAccentedFeedback.classList.add('hidden');
            wordAccentedTime.classList.add('hidden');
            wordInputAccented.disabled = false;
            currentWordIndex_1_2 = 0;

            // Resetear Fase 2
            paragraphTarget1.value = '';
            copyPasteFeedback1.classList.add('hidden');
            paragraphSource1.textContent = originalSource1InitialText; // Restore original for task 2.1
            paragraphSource2.textContent = originalSource2InitialText; // Restore original for task 2.2
            paragraphSource3.textContent = originalSource3InitialText; // Restore original for task 2.3
            paragraphTarget2.value = '';
            copyPasteFeedback2.classList.add('hidden');
            paragraphTarget3.value = '';
            cutPasteFeedback3.classList.add('hidden');
            phase2CurrentTask = 0; // Resetear la tarea actual de la fase 2
            document.getElementById('task2-1').classList.remove('hidden');
            document.getElementById('task2-2').classList.add('hidden');
            document.getElementById('task2-3').classList.add('hidden');
            // Reinitialize the original text variables with normalized text
            Object.assign(phase2Tasks[0], { expected: normalizeWhitespace(paragraphSource1.textContent) });
            Object.assign(phase2Tasks[1], { expected: normalizeWhitespace(targetPhrase2) });
            Object.assign(phase2Tasks[2], { expected: normalizeWhitespace(targetPhrase3) });


            // Resetear Fase 3
            textToFormat.className = 'formatted-text-area'; // Eliminar todas las clases de formato
            textToFormat.textContent = "Este es un p√°rrafo de ejemplo para practicar el formato de texto. Utiliza los atajos de teclado para cambiar su apariencia, tama√±o, color y alineaci√≥n. ¬°Demuestra tu habilidad!"; // Restaurar texto original
            // Reset Phase 3 tracking flags
            boldExecuted = false;
            italicExecuted = false;
            underlineExecuted = false;
            fontCycleCompleted = false;
            sizeCycleCompleted = false;
            colorCycleCompleted = false;
            leftExecuted = false;
            centerExecuted = false;
            rightExecuted = false;
            justifyExecuted = false;
            currentFontIndex = 0; // Reset to default font (Inter)
            currentSizeIndex = 1; // Reset to default size (Medium)
            currentColorIndex = 0; // Reset to default color (Predeterminado)
            updateFormattingStatusDisplay(); // Update display to show reset state


            // Resetear Fase 4
            navigationText.innerHTML = navigationOriginalText; // Restaurar contenido original
            navFeedback.classList.add('hidden');
            currentNavTaskIndex = 0; // Reiniciar √≠ndice de tareas de navegaci√≥n
            removeSelectionListeners(); // Remover listeners para evitar duplicados al reiniciar la fase

            // Resetear Fase 5
            sentenceInput.value = '';
            sentenceFeedback.classList.add('hidden');
            sentenceInput.disabled = false; // Habilitar input
            currentSentenceIndex_5 = 0; // Reiniciar √≠ndice de frases

            // Resetear Fase 6 (Frases Avanzadas)
            sentenceInputAdvanced.value = '';
            sentenceAdvancedFeedback.classList.add('hidden');
            sentenceInputAdvanced.disabled = false;
            currentSentenceIndex_6 = 0;
            // No need to reset userName for this demo, it's hardcoded.

            // Resetear Fase 7 (Quiz de Atajos)
            currentQuizQuestionIndex = 0;
            quizFeedback.classList.add('hidden');
            // Re-enable quiz buttons if they were disabled
            const quizOptionButtons = document.querySelectorAll('#quizOptions button');
            quizOptionButtons.forEach(btn => {
                btn.classList.remove('correct', 'incorrect');
                btn.disabled = false;
            });
        }

        // FASE 1.1: INGRESO DE PALABRA SIMPLE (Original Phase 1)
        const words_1_1 = [
            "teclado", "eficiencia", "velocidad", "digital", "comunicacion",
            "interfaz", "configuracion", "periferico", "algoritmo", "programacion",
            "desarrollo", "compilacion", "depuracion", "memoria", "procesador",
            "redes", "interaccion", "virtual", "escritorio", "documento",
            "archivo", "navegacion", "acceso", "seguridad", "proteccion", "sistema"
        ];
        let currentWordIndex_1_1 = 0;
        let startTime_1_1;

        const wordToType = document.getElementById('wordToType');
        const wordInput = document.getElementById('wordInput');
        const wordFeedback = document.getElementById('wordFeedback');
        const wordTime = document.getElementById('wordTime');

        function startPhase1_1() {
            console.log("[Phase 1.1] Starting...");
            currentWordIndex_1_1 = 0;
            displayWord_1_1();
            wordInput.focus();
            wordInput.removeEventListener('input', checkWordInput_1_1);
            wordInput.removeEventListener('keypress', handleWordEnter_1_1);
            wordInput.addEventListener('input', checkWordInput_1_1);
            wordInput.addEventListener('keypress', handleWordEnter_1_1);
        }

        function displayWord_1_1() {
            if (currentWordIndex_1_1 < words_1_1.length) {
                wordToType.textContent = words_1_1[currentWordIndex_1_1];
                wordInput.value = '';
                wordFeedback.classList.add('hidden');
                wordTime.classList.add('hidden');
                startTime_1_1 = new Date().getTime();
                console.log(`[Phase 1.1] Displaying word: "${words_1_1[currentWordIndex_1_1]}"`);
            } else {
                console.log("[Phase 1.1] All words completed. Advancing to next phase.");
                wordToType.textContent = "¬°Fase 1.1 Completada!";
                wordInput.disabled = true;
                wordInput.removeEventListener('input', checkWordInput_1_1);
                wordInput.removeEventListener('keypress', handleWordEnter_1_1);
                nextPhase1_1Btn.disabled = false;
                autoAdvanceToNextPhase('nextPhase1-1Btn', 'Avanzando a la Fase 1.2...');
            }
        }

        function checkWordInput_1_1() {
            const typedWord = wordInput.value;
            const targetWord = words_1_1[currentWordIndex_1_1];
            console.log(`[Phase 1.1 Check] Typed: "${typedWord}", Target: "${targetWord}"`);

            if (typedWord.toLowerCase() === targetWord.toLowerCase()) { // Case-insensitive for simple words
                const endTime = new Date().getTime();
                const timeTaken = (endTime - startTime_1_1) / 1000;
                wordFeedback.textContent = `¬°Correcto! ‚úîÔ∏è`;
                wordFeedback.classList.remove('hidden', 'feedback-error');
                wordFeedback.classList.add('feedback-success');
                wordTime.querySelector('span').textContent = `${timeTaken.toFixed(2)}s`;
                wordTime.classList.remove('hidden');
                console.log(`[Phase 1.1 Check] Correct word. Time: ${timeTaken.toFixed(2)}s`);

                setTimeout(() => {
                    currentWordIndex_1_1++;
                    displayWord_1_1();
                }, 1000); // Dar 1 segundo antes de la siguiente palabra
            } else if (targetWord.toLowerCase().startsWith(typedWord.toLowerCase())) {
                wordFeedback.classList.add('hidden'); // Ocultar feedback si est√° escribiendo correctamente
            } else {
                wordFeedback.textContent = `Incorrecto. Sigue intentando. ‚ùå`;
                wordFeedback.classList.remove('hidden', 'feedback-success');
                wordFeedback.classList.add('feedback-error');
                console.log("[Phase 1.1 Check] Incorrect word.");
            }
        }

        function handleWordEnter_1_1(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                console.log("[Phase 1.1] Enter key pressed. Checking word input.");
                checkWordInput_1_1();
            }
        }

        // FASE 1.2: ACENTOS Y COMBINACIONES ALT (New Phase)
        const words_1_2 = [
            "c√°psula", "√©l", "dif√≠cil", "cami√≥n", "√∫nico", "ma√±ana", "ping√ºino",
            "Biling√ºe", "ortograf√≠a", "t√©cnica", "inform√°tica", "precisi√≥n",
            "r√°pidamente", "comunicaci√≥n", "configuraci√≥n", "√ëand√∫", "Per√∫",
            "√°rbol", "tel√©fono", "√°guila"
        ];
        let currentWordIndex_1_2 = 0;
        let startTime_1_2;

        const wordToTypeAccented = document.getElementById('wordToTypeAccented');
        const wordInputAccented = document.getElementById('wordInputAccented');
        const wordAccentedFeedback = document.getElementById('wordAccentedFeedback');
        const wordAccentedTime = document.getElementById('wordAccentedTime');

        function startPhase1_2() {
            console.log("[Phase 1.2] Starting...");
            currentWordIndex_1_2 = 0;
            displayWord_1_2();
            wordInputAccented.focus();
            wordInputAccented.removeEventListener('input', checkWordInput_1_2);
            wordInputAccented.removeEventListener('keypress', handleWordEnter_1_2);
            wordInputAccented.addEventListener('input', checkWordInput_1_2);
            wordInputAccented.addEventListener('keypress', handleWordEnter_1_2);
        }

        function displayWord_1_2() {
            if (currentWordIndex_1_2 < words_1_2.length) {
                wordToTypeAccented.textContent = words_1_2[currentWordIndex_1_2];
                wordInputAccented.value = '';
                wordAccentedFeedback.classList.add('hidden');
                wordAccentedTime.classList.add('hidden');
                startTime_1_2 = new Date().getTime();
                console.log(`[Phase 1.2] Displaying word: "${words_1_2[currentWordIndex_1_2]}"`);
            } else {
                console.log("[Phase 1.2] All words completed. Advancing to next phase.");
                wordToTypeAccented.textContent = "¬°Fase 1.2 Completada!";
                wordInputAccented.disabled = true;
                wordInputAccented.removeEventListener('input', checkWordInput_1_2);
                wordInputAccented.removeEventListener('keypress', handleWordEnter_1_2);
                nextPhase1_2Btn.disabled = false;
                autoAdvanceToNextPhase('nextPhase1-2Btn', 'Avanzando a la Fase 2...');
            }
        }

        function checkWordInput_1_2() {
            const typedWord = wordInputAccented.value;
            const targetWord = words_1_2[currentWordIndex_1_2];
            console.log(`[Phase 1.2 Check] Typed: "${typedWord}", Target: "${targetWord}"`);

            if (typedWord === targetWord) { // Exact match for accents, case, etc.
                const endTime = new Date().getTime();
                const timeTaken = (endTime - startTime_1_2) / 1000;
                wordAccentedFeedback.textContent = `¬°Correcto! ‚úîÔ∏è`;
                wordAccentedFeedback.classList.remove('hidden', 'feedback-error');
                wordAccentedFeedback.classList.add('feedback-success');
                wordAccentedTime.querySelector('span').textContent = `${timeTaken.toFixed(2)}s`;
                wordAccentedTime.classList.remove('hidden');
                console.log(`[Phase 1.2 Check] Correct word. Time: ${timeTaken.toFixed(2)}s`);

                setTimeout(() => {
                    currentWordIndex_1_2++;
                    displayWord_1_2();
                }, 1000);
            } else if (targetWord.startsWith(typedWord)) { // Partial match
                wordAccentedFeedback.classList.add('hidden');
            } else {
                wordAccentedFeedback.textContent = `Incorrecto. ¬°Revisa acentos y may√∫sculas! ‚ùå`;
                wordAccentedFeedback.classList.remove('hidden', 'feedback-success');
                wordAccentedFeedback.classList.add('feedback-error');
                console.log("[Phase 1.2 Check] Incorrect word.");
            }
        }

        function handleWordEnter_1_2(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                console.log("[Phase 1.2] Enter key pressed. Checking word input.");
                checkWordInput_1_2();
            }
        }

        // FASE 2: COPIAR, CORTAR, PEGAR
        const task2_1Div = document.getElementById('task2-1');
        const task2_2Div = document.getElementById('task2-2');
        const task2_3Div = document.getElementById('task2-3');

        const paragraphSource1 = document.getElementById('paragraphSource1');
        const paragraphTarget1 = document.getElementById('paragraphTarget1');
        const copyPasteFeedback1 = document.getElementById('copyPasteFeedback1');
        // Store initial raw text to reset reliably
        const originalSource1InitialText = paragraphSource1.textContent;

        const paragraphSource2 = document.getElementById('paragraphSource2');
        const paragraphTarget2 = document.getElementById('paragraphTarget2');
        const copyPasteFeedback2 = document.getElementById('copyPasteFeedback2');
        const targetPhrase2 = "La pr√°ctica constante lleva a la maestr√≠a.";
        const originalSource2InitialText = paragraphSource2.textContent;

        const paragraphSource3 = document.getElementById('paragraphSource3');
        const paragraphTarget3 = document.getElementById('paragraphTarget3');
        const cutPasteFeedback3 = document.getElementById('cutPasteFeedback3');
        const targetPhrase3 = "habilidades de edici√≥n avanzadas.";
        const originalSource3InitialText = paragraphSource3.textContent; // Store initial raw text for task 2.3

        let phase2CurrentTask = 0; // 0 = task2-1, 1 = task2-2, 2 = task2-3

        // Define phase2Tasks using initial raw text for resetting, but normalized text for comparison
        const phase2Tasks = [
            { source: paragraphSource1, target: paragraphTarget1, feedback: copyPasteFeedback1, type: 'copy', expected: normalizeWhitespace(originalSource1InitialText), taskDiv: task2_1Div },
            { source: paragraphSource2, target: paragraphTarget2, feedback: copyPasteFeedback2, type: 'copy', expected: normalizeWhitespace(targetPhrase2), taskDiv: task2_2Div },
            { source: paragraphSource3, target: paragraphTarget3, feedback: cutPasteFeedback3, type: 'cut', expected: normalizeWhitespace(targetPhrase3), taskDiv: task2_3Div }
        ];

        function startPhase2() {
            console.log("[Phase 2] Starting...");
            phase2CurrentTask = 0; // Ensure start from the first task
            displayPhase2Task();
            // Attach paste and cut listeners globally or on relevant elements
            document.removeEventListener('paste', handlePasteEvent);
            document.removeEventListener('cut', handleCutEvent);
            document.addEventListener('paste', handlePasteEvent);
            document.addEventListener('cut', handleCutEvent);

            // Add Ctrl+A listener for selection specific to contenteditable divs
            document.removeEventListener('keydown', handleCtrlASelection);
            document.addEventListener('keydown', handleCtrlASelection);
        }

        function displayPhase2Task() {
            console.log(`[Phase 2] Displaying task: ${phase2CurrentTask + 1}`);
            // Hide all task divs first
            phase2Tasks.forEach(task => task.taskDiv.classList.add('hidden'));

            if (phase2CurrentTask < phase2Tasks.length) {
                const currentTask = phase2Tasks[phase2CurrentTask];
                currentTask.taskDiv.classList.remove('hidden');
                currentTask.target.value = ''; // Clear target area for new task
                currentTask.feedback.classList.add('hidden');

                // Restore original text content for the current source div
                if (currentTask.source === paragraphSource1) {
                    currentTask.source.textContent = originalSource1InitialText;
                } else if (currentTask.source === paragraphSource2) {
                    currentTask.source.textContent = originalSource2InitialText;
                } else if (currentTask.source === paragraphSource3) {
                    currentTask.source.textContent = originalSource3InitialText;
                }

                // Set cursor at the beginning of the source contenteditable div
                const range = document.createRange();
                const selection = window.getSelection();
                // Ensure there is a first child node to set range start
                if (currentTask.source.firstChild) {
                    range.setStart(currentTask.source.firstChild, 0);
                } else {
                    range.setStart(currentTask.source, 0);
                }
                range.collapse(true); // Collapse to the start
                selection.removeAllRanges();
                selection.addRange(range);
                currentTask.source.focus(); // Explicitly focus the source div

            } else {
                console.log("[Phase 2] All tasks completed. Advancing to next phase.");
                // All Phase 2 tasks completed
                document.removeEventListener('paste', handlePasteEvent);
                document.removeEventListener('cut', handleCutEvent);
                document.removeEventListener('keydown', handleCtrlASelection); // Remove Ctrl+A listener
                nextPhase2Btn.disabled = false; // ENABLE BUTTON FOR AUTO-ADVANCE
                autoAdvanceToNextPhase('nextPhase2Btn', 'Avanzando a la Fase 3...');
            }
        }

        function handlePasteEvent(e) {
            const currentTask = phase2Tasks[phase2CurrentTask];
            console.log(`[Paste Event] Active element: ${document.activeElement.id}, Current task target: ${currentTask.target.id}`);
            // Only act if the paste event is on the current target textarea
            if (document.activeElement === currentTask.target) {
                e.preventDefault(); // Prevent default paste to handle manually
                const pastedText = normalizeWhitespace((e.clipboardData || window.clipboardData).getData('Text')); // Normalize pasted text
                console.log(`[Paste Event] Pasted text (normalized): "${pastedText}"`);

                currentTask.target.value = pastedText; // Manually set pasted text

                if (currentTask.type === 'copy') {
                    console.log(`[Paste Event - Copy Task] Expected: "${currentTask.expected}"`);
                    if (pastedText === currentTask.expected) { // Compare normalized texts
                        currentTask.feedback.textContent = '¬°Correcto! ‚úîÔ∏è';
                        currentTask.feedback.classList.remove('hidden', 'feedback-error');
                        currentTask.feedback.classList.add('feedback-success');
                        console.log("[Paste Event - Copy Task] Correct paste. Advancing task.");
                        setTimeout(() => {
                            phase2CurrentTask++;
                            displayPhase2Task();
                        }, 1000);
                    } else {
                        currentTask.feedback.textContent = 'Incorrecto. Aseg√∫rate de copiar el texto exacto. ‚ùå';
                        currentTask.feedback.classList.remove('hidden', 'feedback-success');
                        currentTask.feedback.classList.add('feedback-error');
                        console.log("[Paste Event - Copy Task] Incorrect paste.");
                    }
                } else if (currentTask.type === 'cut') {
                    console.log("[Paste Event - Cut Task] Calling checkCutPasteWithPaste.");
                    checkCutPasteWithPaste(pastedText);
                }
            }
        }

        function handleCutEvent(e) {
            const currentTask = phase2Tasks[phase2CurrentTask];
            console.log(`[Cut Event] Active element: ${document.activeElement.id}, Current task source: ${currentTask.source.id}`);
            // Only act if the cut event is on the current source div and it's a cut task
            if (document.activeElement === currentTask.source && currentTask.type === 'cut') {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const cutText = normalizeWhitespace(selection.toString()); // Normalize cut text
                    console.log(`[Cut Event] Cut text (normalized): "${cutText}"`);
                    // Store cut text temporarily to verify when pasted
                    e.clipboardData.setData('text/plain', cutText);
                    e.preventDefault(); // Prevent default cut
                    // Manually remove selected content
                    const range = selection.getRangeAt(0);
                    range.deleteContents();
                    // Set focus to target to allow pasting immediately
                    if (currentTask.target) { // Add a check in case target is null (due to previous bug)
                        currentTask.target.focus();
                        console.log("[Cut Event] Text cut and focus moved to target.");
                    } else {
                        console.error("[Cut Event] Target element is null, cannot focus.");
                    }
                }
            }
        }

        // Separate function to check cut/paste success (called by handlePasteEvent for cut tasks)
        function checkCutPasteWithPaste(pastedText) {
            const currentTask = phase2Tasks[phase2CurrentTask];
            const originalSourceTextNormalized = normalizeWhitespace(originalSource3InitialText); // Normalized original for comparison
            const currentSourceTextNormalized = normalizeWhitespace(paragraphSource3.textContent); // Normalized current source after cut
            const expectedSourceAfterCutNormalized = normalizeWhitespace(originalSource3InitialText.replace(targetPhrase3, '')); // Normalize expected remaining text

            console.log(`[Cut/Paste Check] Pasted Text: "${pastedText}" (Expected: "${currentTask.expected}")`);
            console.log(`[Cut/Paste Check] Current Source Text: "${currentSourceTextNormalized}" (Expected After Cut: "${expectedSourceAfterCutNormalized}")`);

            if (currentSourceTextNormalized === expectedSourceAfterCutNormalized && pastedText === currentTask.expected) {
                cutPasteFeedback3.textContent = '¬°Correcto! ‚úîÔ∏è';
                cutPasteFeedback3.classList.remove('hidden', 'feedback-error');
                cutPasteFeedback3.classList.add('feedback-success');
                console.log("[Cut/Paste Check] Correct cut and paste. Advancing task.");
                setTimeout(() => {
                    phase2CurrentTask++;
                    displayPhase2Task(); // Advance to next task
                }, 1000);
            } else {
                cutPasteFeedback3.textContent = 'Incorrecto. Aseg√∫rate de cortar la frase del origen y pegarla correctamente en el destino. ‚ùå';
                cutPasteFeedback3.classList.remove('hidden', 'feedback-success');
                cutPasteFeedback3.classList.add('feedback-error');
                console.log("[Cut/Paste Check] Incorrect cut or paste.");
            }
        }

        function handleCtrlASelection(e) {
            if (e.ctrlKey && e.key === 'a') {
                const activeElement = document.activeElement;
                if (activeElement === paragraphSource1 || activeElement === paragraphSource2 || activeElement === paragraphSource3) {
                    e.preventDefault(); // Prevent default Ctrl+A (select all browser content)
                    console.log(`[Ctrl+A] Preventing default and selecting content of: ${activeElement.id}`);

                    const range = document.createRange();
                    const selection = window.getSelection();

                    range.selectNodeContents(activeElement); // Select only the content of the active div
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
            }
        }


        // FASE 3: FORMATO DE TEXTO (Simulaci√≥n Word Shortcuts)
        const textToFormat = document.getElementById('textToFormat');
        const fontClasses = ['font-arial', 'font-courier-new', 'font-times-new-roman'];
        const fontNames = ['Inter', 'Arial', 'Courier New', 'Times New Roman'];
        const sizeClasses = ['size-small', 'size-medium', 'size-large'];
        const sizeNames = ['Peque√±o', 'Medio', 'Grande'];
        const colorClasses = ['color-red', 'color-blue', 'color-green'];
        const colorNames = ['Predeterminado', 'Rojo', 'Azul', 'Verde'];
        // const colorHexValues = ['#dc2626', '#2563eb', '#059669']; // No direct use, but kept for reference

        let currentFontIndex = 0;
        let currentSizeIndex = 1; // Empezar en tama√±o medio
        let currentColorIndex = 0; // Empezar en Predeterminado

        // Tracking flags for Phase 3 completion - now for *at least one activation*
        let boldExecuted = false;
        let italicExecuted = false;
        let underlineExecuted = false;
        let fontCycleCompleted = false; // At least one font change
        let sizeCycleCompleted = false; // At least one size change
        let colorCycleCompleted = false; // At least one color change
        let leftExecuted = false;
        let centerExecuted = false;
        let rightExecuted = false;
        let justifyExecuted = false;

        // Status display elements
        const statusBold = document.getElementById('statusBold');
        const statusItalic = document.getElementById('statusItalic');
        const statusUnderline = document.getElementById('statusUnderline');
        const statusFont = document.getElementById('statusFont');
        const statusSize = document.getElementById('statusSize');
        const statusColor = document.getElementById('statusColor');
        const statusAlign = document.getElementById('statusAlign');


        function startPhase3() {
            console.log("[Phase 3] Starting...");
            // Reset flags and text content here for a clean start
            textToFormat.textContent = "Este es un p√°rrafo de ejemplo para practicar el formato de texto. Utiliza los atajos de teclado para cambiar su apariencia, tama√±o, color y alineaci√≥n. ¬°Demuestra tu habilidad!";
            textToFormat.className = 'formatted-text-area'; // Clear all dynamic classes

            boldExecuted = false;
            italicExecuted = false;
            underlineExecuted = false;
            fontCycleCompleted = false;
            sizeCycleCompleted = false;
            colorCycleCompleted = false;
            leftExecuted = false;
            centerExecuted = false;
            rightExecuted = false;
            justifyExecuted = false;
            currentFontIndex = 0;
            currentSizeIndex = 1;
            currentColorIndex = 0;

            textToFormat.focus();
            updateFormattingStatusDisplay(); // Initial display update
            document.removeEventListener('keydown', handleFormattingShortcuts);
            document.addEventListener('keydown', handleFormattingShortcuts);
            // No auto-advance on start; it will be triggered by checkPhase3Completion
        }

        function updateFormattingStatusDisplay() {
            // Query current selection state for bold, italic, underline, alignment
            // Note: These will reflect the state at the current cursor position or selection.
            statusBold.textContent = document.queryCommandState('bold') ? 'ACTIVADO' : 'DESACTIVADO';
            statusBold.classList.toggle('on', document.queryCommandState('bold'));
            statusBold.classList.toggle('off', !document.queryCommandState('bold'));

            statusItalic.textContent = document.queryCommandState('italic') ? 'ACTIVADO' : 'DESACTIVADO';
            statusItalic.classList.toggle('on', document.queryCommandState('italic'));
            statusItalic.classList.toggle('off', !document.queryCommandState('italic'));

            statusUnderline.textContent = document.queryCommandState('underline') ? 'ACTIVADO' : 'DESACTIVADO';
            statusUnderline.classList.toggle('on', document.queryCommandState('underline'));
            statusUnderline.classList.toggle('off', !document.queryCommandState('underline'));

            // For font, size, color, we still rely on classes on the main div
            statusFont.textContent = fontNames[currentFontIndex];
            statusSize.textContent = sizeNames[currentSizeIndex];
            statusColor.textContent = colorNames[currentColorIndex];

            // Alignment check using queryCommandState
            if (document.queryCommandState('justifyLeft')) {
                statusAlign.textContent = 'Izquierda';
            } else if (document.queryCommandState('justifyCenter')) {
                statusAlign.textContent = 'Centrar';
            } else if (document.queryCommandState('justifyRight')) {
                statusAlign.textContent = 'Derecha';
            } else if (document.queryCommandState('justifyFull')) {
                statusAlign.textContent = 'Justificar';
            } else {
                statusAlign.textContent = 'Izquierda'; // Default
            }

            checkPhase3Completion();
        }

        function checkPhase3Completion() {
            console.log(`[Phase 3 Completion Check] Bold: ${boldExecuted}, Italic: ${italicExecuted}, Underline: ${underlineExecuted}, Font: ${fontCycleCompleted}, Size: ${sizeCycleCompleted}, Color: ${colorCycleCompleted}, Left: ${leftExecuted}, Center: ${centerExecuted}, Right: ${rightExecuted}, Justify: ${justifyExecuted}`);
            if (boldExecuted && italicExecuted && underlineExecuted &&
                fontCycleCompleted && sizeCycleCompleted && colorCycleCompleted &&
                leftExecuted && centerExecuted && rightExecuted && justifyExecuted) {
                console.log("[Phase 3] All formatting conditions met. Advancing to next phase.");
                nextPhase3Btn.disabled = false;
                autoAdvanceToNextPhase('nextPhase3Btn', '¬°Formato Completo! Avanzando a la Fase 4...');
                document.removeEventListener('keydown', handleFormattingShortcuts);
            }
        }

        function handleFormattingShortcuts(e) {
            const isCtrl = e.ctrlKey || e.metaKey;
            const isShift = e.shiftKey;

            if (document.activeElement !== textToFormat) {
                return;
            }
            console.log(`[Phase 3 - Shortcut] Key: ${e.key}, Ctrl: ${isCtrl}, Shift: ${isShift}`);

            if (isCtrl && !isShift && e.key === 'n') { // Ctrl + N (Bold)
                e.preventDefault(); // Prevent default browser behavior (new window)
                document.execCommand('bold', false, null); // Apply to current selection
                boldExecuted = true;
            } else if (isCtrl && !isShift && e.key === 'k') { // Ctrl + K (Italic)
                e.preventDefault(); // Prevent default browser behavior (search/favorites)
                document.execCommand('italic', false, null); // Apply to current selection
                italicExecuted = true;
            } else if (isCtrl && !isShift && e.key === 's') { // Ctrl + S (Underline)
                e.preventDefault(); // Prevent default browser behavior (save page)
                document.execCommand('underline', false, null); // Apply to current selection
                underlineExecuted = true;
            } else if (isCtrl && isShift && e.key === 'F') { // Ctrl + Shift + F (Change Font - Simulated on whole div)
                e.preventDefault();
                textToFormat.classList.remove(...fontClasses);
                currentFontIndex = (currentFontIndex + 1) % fontClasses.length;
                textToFormat.classList.add(fontClasses[currentFontIndex]);
                fontCycleCompleted = true; // Mark as completed after at least one change
            } else if (isCtrl && isShift && e.key === '>') { // Ctrl + Shift + > (Aumentar Tama√±o - Simulated on whole div)
                e.preventDefault();
                textToFormat.classList.remove(...sizeClasses);
                currentSizeIndex = Math.min(currentSizeIndex + 1, sizeClasses.length - 1);
                textToFormat.classList.add(sizeClasses[currentSizeIndex]);
                sizeCycleCompleted = true; // Mark as completed after at least one change
            } else if (isCtrl && isShift && e.key === '<') { // Ctrl + Shift + < (Disminuir Tama√±o - Simulated on whole div)
                e.preventDefault();
                textToFormat.classList.remove(...sizeClasses);
                currentSizeIndex = Math.max(currentSizeIndex - 1, 0);
                textToFormat.classList.add(sizeClasses[currentSizeIndex]);
                sizeCycleCompleted = true; // Mark as completed after at least one change
            } else if (isCtrl && isShift && e.key === 'C') { // Ctrl + Shift + C (Change Color - Simulated on whole div)
                e.preventDefault();
                // Cycle through colors and default. If currentColorIndex is 0, it means default.
                // The classList approach is less direct for colors unless we map each color to a class explicitly.
                // For simplicity, we'll just toggle through the provided classes.
                textToFormat.classList.remove('color-red', 'color-blue', 'color-green'); // Remove all color classes
                currentColorIndex = (currentColorIndex + 1) % (colorClasses.length + 1); // Cycle through 0 (default) and actual colors
                if (currentColorIndex > 0) { // If not default
                    textToFormat.classList.add(colorClasses[currentColorIndex - 1]);
                }
                colorCycleCompleted = true; // Mark as completed after at least one change
            } else if (isCtrl && !isShift && e.key === 'q') { // Ctrl + Q (Align Left)
                e.preventDefault();
                document.execCommand('justifyLeft', false, null);
                leftExecuted = true;
            } else if (isCtrl && !isShift && e.key === 't') { // Ctrl + T (Center) - In MS Word, this is Ctrl+E
                e.preventDefault(); // Prevent default browser behavior (new tab)
                document.execCommand('justifyCenter', false, null);
                centerExecuted = true;
            } else if (isCtrl && !isShift && e.key === 'd') { // Ctrl + D (Align Right) - In MS Word, this is Ctrl+R
                e.preventDefault();
                document.execCommand('justifyRight', false, null);
                rightExecuted = true;
            } else if (isCtrl && !isShift && e.key === 'j') { // Ctrl + J (Justify)
                e.preventDefault();
                document.execCommand('justifyFull', false, null);
                justifyExecuted = true;
            }
            // Update the display and check completion after any shortcut is pressed
            updateFormattingStatusDisplay();
        }


        // FASE 4: NAVEGACI√ìN DE TEXTO
        const navigationText = document.getElementById('navigationText');
        const targetNavWordSpan = document.getElementById('targetNavWord');
        const navFeedback = document.getElementById('navFeedback');
        const navigationOriginalText = navigationText.innerHTML; // Guardar el HTML original

        const navTasks = [
            {
                word: "√©tica",
                tip: "Usa Ctrl + Flecha para saltar palabras."
            },
            {
                word: "revolucionar",
                tip: "Intenta Ctrl + Home para ir al inicio, luego navega."
            },
            {
                word: "privacidad",
                tip: "Puedes usar la flecha abajo para bajar l√≠neas."
            }
        ];
        let currentNavTaskIndex = 0;

        function startPhase4() {
            console.log("[Phase 4] Starting...");
            navigationText.focus();
            displayNavTask();

            // Listen for Enter key to check navigation
            document.removeEventListener('keydown', handleNavigationCheck); // Remove existing
            document.addEventListener('keydown', handleNavigationCheck);
        }

        function displayNavTask() {
            console.log(`[Phase 4] Displaying task: ${currentNavTaskIndex + 1}`);
            if (currentNavTaskIndex < navTasks.length) {
                const task = navTasks[currentNavTaskIndex];
                targetNavWordSpan.textContent = task.word;
                navFeedback.classList.add('hidden');
                // Eliminar resaltado anterior y restaurar el texto
                navigationText.innerHTML = navigationOriginalText;
                highlightTargetWord(task.word);
                // Set initial focus
                navigationText.focus();
                // Move cursor to start of div for current task
                const range = document.createRange();
                const selection = window.getSelection();

                // To reliably set cursor at the beginning of the contenteditable div's text
                if (navigationText.firstChild) {
                    range.setStart(navigationText.firstChild, 0);
                } else {
                    range.setStart(navigationText, 0);
                }
                range.collapse(true); // Collapse to the start
                selection.removeAllRanges();
                selection.addRange(range);
                console.log(`[Phase 4] Target word: "${task.word}". Cursor set to start of text area.`);

            } else {
                console.log("[Phase 4] All tasks completed. Advancing to next phase.");
                navFeedback.textContent = "¬°Todas las tareas de navegaci√≥n completadas! ‚úîÔ∏è";
                navFeedback.classList.remove('hidden', 'feedback-error');
                navFeedback.classList.add('feedback-success');
                removeSelectionListeners(); // Remove listeners specific to phase 4
                nextPhase4Btn.disabled = false; // ENABLE BUTTON FOR AUTO-ADVANCE
                autoAdvanceToNextPhase('nextPhase4Btn', 'Avanzando a la Fase 5...');
            }
        }

        function highlightTargetWord(word) {
            const content = navigationText.innerHTML;
            const regex = new RegExp(`(${word})`, 'gi');
            navigationText.innerHTML = content.replace(regex, '<span class="navigation-highlight"><strong>$1</strong></span>');
        }

        function handleNavigationCheck(e) {
            if (document.activeElement === navigationText && e.key === 'Enter') {
                e.preventDefault(); // Prevent new line in contenteditable
                console.log("[Phase 4] Enter pressed. Checking navigation.");
                const task = navTasks[currentNavTaskIndex];
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const targetWord = task.word;
                    const textContent = normalizeWhitespace(navigationText.textContent); // Normalize text content for comparison
                    const index = textContent.indexOf(normalizeWhitespace(targetWord));
                    console.log(`[Phase 4 Check] Target word: "${targetWord}" (normalized: "${normalizeWhitespace(targetWord)}")`);
                    console.log(`[Phase 4 Check] Full text content (normalized): "${textContent}"`);
                    console.log(`[Phase 4 Check] Target word index in normalized text: ${index}`);

                    if (index !== -1) {
                        // Calculate the absolute character offset of the cursor from the start of the contenteditable div.
                        const preCaretRange = range.cloneRange();
                        preCaretRange.selectNodeContents(navigationText);
                        preCaretRange.setEnd(range.startContainer, range.startOffset);
                        const cursorAbsoluteStartOffset = normalizeWhitespace(preCaretRange.toString()).length;

                        // Find the start offset of the target word in the *normalized* text content
                        const targetWordStartAbsolute = textContent.indexOf(normalizeWhitespace(targetWord));

                        console.log(`[Phase 4 Check] Cursor absolute start offset (normalized): ${cursorAbsoluteStartOffset}`);
                        console.log(`[Phase 4 Check] Target word absolute start offset (normalized): ${targetWordStartAbsolute}`);


                        // Allow a small tolerance for cursor position around the start of the word
                        // This tolerates if the user is slightly before or exactly at the start of the word.
                        const tolerance = 2; // e.g., allow cursor 2 characters before the word
                        if (cursorAbsoluteStartOffset >= targetWordStartAbsolute - tolerance && cursorAbsoluteStartOffset <= (targetWordStartAbsolute + targetWord.length)) {
                            navFeedback.textContent = `¬°Correcto! Est√°s al inicio de la palabra "<strong>${task.word}</strong>". ‚úîÔ∏è`;
                            navFeedback.classList.remove('hidden', 'feedback-error');
                            navFeedback.classList.add('feedback-success');
                            console.log("[Phase 4 Check] Correct navigation. Advancing task.");
                            setTimeout(() => {
                                currentNavTaskIndex++;
                                displayNavTask();
                            }, 1000);
                            return;
                        }
                    }

                    navFeedback.textContent = `Incorrecto. No est√°s al principio de la palabra "<strong>${task.word}</strong>". Sigue intentando. ‚ùå`;
                    navFeedback.classList.remove('hidden', 'feedback-success');
                    navFeedback.classList.add('feedback-error');
                    console.log("[Phase 4 Check] Incorrect navigation.");

                } else {
                    navFeedback.textContent = 'Aseg√∫rate de enfocar el texto y navegar con el teclado. ‚ùå';
                    navFeedback.classList.remove('hidden', 'feedback-success');
                    navFeedback.classList.add('feedback-error');
                    console.log("[Phase 4 Check] No selection range.");
                }
            }
        }

        function removeSelectionListeners() {
            document.removeEventListener('keydown', handleNavigationCheck);
            document.removeEventListener('paste', handlePasteEvent);
            document.removeEventListener('cut', handleCutEvent);
            document.removeEventListener('keydown', handleCtrlASelection);
            console.log("[Listeners] Removed selection-related listeners.");
        }

        // FASE 5: COMPLETAR FRASES (Palabras sueltas)
        const sentences_5 = [
            { full: "El sistema operativo es el ______ fundamental de un ordenador.", blank: "software", placeholder: "software" },
            { full: "Para copiar un texto, usa la combinaci√≥n de teclas Ctrl + ______.", blank: "C", placeholder: "C" },
            { full: "Los atajos de teclado aumentan la ______.", blank: "productividad", placeholder: "productividad" },
            { full: "La navegaci√≥n por texto se facilita con las teclas de ______.", blank: "direcci√≥n", placeholder: "direcci√≥n" },
            { full: "Word es un procesador de ______.", blank: "texto", placeholder: "texto" },
            { full: "La funci√≥n de ______ permite reordenar el texto en un documento.", blank: "cortar", placeholder: "cortar" },
            { full: "Para ir al inicio de una l√≠nea, presiona la tecla ______.", blank: "Inicio", placeholder: "Inicio" },
            { full: "La ______ artificial est√° revolucionando muchas industrias.", blank: "inteligencia", placeholder: "inteligencia" },
            { full: "Un documento debe tener un formato claro y ______.", blank: "legible", placeholder: "legible" },
            { full: "El atajo para pegar es Ctrl + ______.", blank: "V", placeholder: "V" }
        ];
        let currentSentenceIndex_5 = 0;
        const sentenceToComplete = document.getElementById('sentenceToComplete');
        const sentenceInput = document.getElementById('sentenceInput');
        const sentenceFeedback = document.getElementById('sentenceFeedback');

        function startPhase5() {
            console.log("[Phase 5] Starting...");
            currentSentenceIndex_5 = 0;
            displaySentence_5();
            sentenceInput.focus();
            sentenceInput.removeEventListener('input', checkSentenceInput_5);
            sentenceInput.removeEventListener('keypress', handleSentenceEnter_5);
            sentenceInput.addEventListener('input', checkSentenceInput_5);
            sentenceInput.addEventListener('keypress', handleSentenceEnter_5);
        }

        function displaySentence_5() {
            if (currentSentenceIndex_5 < sentences_5.length) {
                const currentSentence = sentences_5[currentSentenceIndex_5];
                const parts = currentSentence.full.split('______');
                sentenceToComplete.innerHTML = `${parts[0]}<span class="text-red-500">[${currentSentence.placeholder}]</span>${parts[1]}`;
                sentenceInput.value = '';
                sentenceInput.placeholder = `Escribe aqu√≠ "${currentSentence.placeholder}"`;
                sentenceFeedback.classList.add('hidden');
                console.log(`[Phase 5] Displaying sentence task. Target: "${currentSentence.blank}"`);
            } else {
                console.log("[Phase 5] All sentences completed. Advancing to final screen.");
                sentenceToComplete.textContent = "¬°Todas las frases completadas!";
                sentenceInput.disabled = true;
                sentenceInput.removeEventListener('input', checkSentenceInput_5);
                sentenceInput.removeEventListener('keypress', handleSentenceEnter_5);
                nextPhase5Btn.disabled = false; // ENABLE BUTTON FOR AUTO-ADVANCE
                autoAdvanceToNextPhase('nextPhase5Btn', 'Avanzando a la Fase 6...', 2000);
            }
        }

        function checkSentenceInput_5() {
            const typedPart = sentenceInput.value.trim();
            const targetPart = sentences_5[currentSentenceIndex_5].blank;
            console.log(`[Phase 5 Check] Typed: "${typedPart}", Target: "${targetPart}"`);

            if (typedPart === targetPart) {
                sentenceFeedback.textContent = `¬°Correcto! ‚úîÔ∏è`;
                sentenceFeedback.classList.remove('hidden', 'feedback-error');
                sentenceFeedback.classList.add('feedback-success');
                console.log("[Phase 5 Check] Correct word. Advancing sentence.");
                setTimeout(() => {
                    currentSentenceIndex_5++;
                    displaySentence_5();
                }, 1000);
            } else if (targetPart.toLowerCase().startsWith(typedPart.toLowerCase())) {
                 sentenceFeedback.classList.add('hidden');
            }
            else {
                sentenceFeedback.textContent = `Incorrecto. Sigue intentando. ‚ùå`;
                sentenceFeedback.classList.remove('hidden', 'feedback-success');
                sentenceFeedback.classList.add('feedback-error');
                console.log("[Phase 5 Check] Incorrect word.");
            }
        }

        function handleSentenceEnter_5(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                console.log("[Phase 5] Enter key pressed. Checking sentence input.");
                checkSentenceInput_5();
            }
        }

        // FASE 6: COMPLETAR FRASES AVANZADAS (Puntuaci√≥n, May√∫sculas, Acentos) - NEW PHASE
       const userName = "Juan"; // Placeholder for user's name
const sentences_6 = [
    { 
        full: `Hola, mi nombre es ${userName}. ¬øC√≥mo est√°s hoy?`, 
        expected: [`Hola, mi nombre es ${userName}. ¬øC√≥mo est√°s hoy?`], 
        placeholder: `Hola, mi nombre es ${userName}. ¬øC√≥mo est√°s hoy?` 
    },
    { 
        full: `¬°Qu√© d√≠a tan bonito! Hay 100% de probabilidad de sol.`, 
        expected: [`¬°Qu√© d√≠a tan bonito! Hay 100% de probabilidad de sol.`], 
        placeholder: `¬°Qu√© d√≠a tan bonito! Hay 100% de probabilidad de sol.` 
    },
    { 
        full: `La f√≥rmula es E=mc¬≤.`, 
        expected: [`La f√≥rmula es E=mc¬≤.`, `La f√≥rmula es E=mc^2.`], 
        placeholder: `La f√≥rmula es E=mc¬≤ (Usa Alt+0178!)` 
    },
    { 
        full: `El precio es $50.00 (cincuenta d√≥lares).`, 
        expected: [`El precio es $50.00 (cincuenta d√≥lares).`], 
        placeholder: `El precio es $50.00 (cincuenta d√≥lares).` 
    },
    { 
        full: `Ella dijo: "Ven aqu√≠ ahora".`, 
        expected: [`Ella dijo: "Ven aqu√≠ ahora".`], 
        placeholder: `Ella dijo: "Ven aqu√≠ ahora".` 
    },
    { 
        full: `¬øD√≥nde est√° la m√°quina?`, 
        expected: [`¬øD√≥nde est√° la m√°quina?`], 
        placeholder: `¬øD√≥nde est√° la m√°quina?` 
    },
    { 
        full: `El autob√∫s n√∫mero 7 (siete) lleg√≥ a las 8:30 a.m.`, 
        expected: [`El autob√∫s n√∫mero 7 (siete) lleg√≥ a las 8:30 a.m.`], 
        placeholder: `El autob√∫s n√∫mero 7 (siete) lleg√≥ a las 8:30 a.m.` 
    }
];

let currentSentenceIndex_6 = 0;
const sentenceToTypeAdvanced = document.getElementById('sentenceToTypeAdvanced');
const sentenceInputAdvanced = document.getElementById('sentenceInputAdvanced');
const sentenceAdvancedFeedback = document.getElementById('sentenceAdvancedFeedback');

function startPhase6() {
    console.log("[Phase 6] Starting...");
    currentSentenceIndex_6 = 0;
    displaySentence_6();
    sentenceInputAdvanced.focus();
    sentenceInputAdvanced.removeEventListener('input', checkSentenceInput_6);
    sentenceInputAdvanced.removeEventListener('keypress', handleSentenceEnter_6);
    sentenceInputAdvanced.addEventListener('input', checkSentenceInput_6);
    sentenceInputAdvanced.addEventListener('keypress', handleSentenceEnter_6);
    document.removeEventListener('keydown', handleSuperscriptPrevention);
    document.addEventListener('keydown', handleSuperscriptPrevention);
}

function displaySentence_6() {
    if (currentSentenceIndex_6 < sentences_6.length) {
        const currentSentence = sentences_6[currentSentenceIndex_6];
        sentenceToTypeAdvanced.textContent = currentSentence.full;
        sentenceInputAdvanced.value = '';
        sentenceInputAdvanced.placeholder = `Escribe exactamente: "${currentSentence.placeholder}"`;
        sentenceAdvancedFeedback.classList.add('hidden');
        console.log(`[Phase 6] Displaying sentence task. Targets: ${currentSentence.expected.join(" | ")}`);
    } else {
        console.log("[Phase 6] All sentences completed. Advancing to next phase.");
        sentenceToTypeAdvanced.textContent = "¬°Todas las frases avanzadas completadas!";
        sentenceInputAdvanced.disabled = true;
        sentenceInputAdvanced.removeEventListener('input', checkSentenceInput_6);
        sentenceInputAdvanced.removeEventListener('keypress', handleSentenceEnter_6);
        document.removeEventListener('keydown', handleSuperscriptPrevention);
        nextPhase6Btn.disabled = false;
        autoAdvanceToNextPhase('nextPhase6Btn', 'Avanzando a la Fase 7...', 2000);
    }
}

function checkSentenceInput_6() {
    const typedText = sentenceInputAdvanced.value; 
    const targetExpected = sentences_6[currentSentenceIndex_6].expected;
    const expectedArray = Array.isArray(targetExpected) ? targetExpected : [targetExpected];

    console.log(`[Phase 6 Check] Typed: "${typedText}", Targets: ${expectedArray}`);

    if (expectedArray.includes(typedText)) { 
        sentenceAdvancedFeedback.textContent = `¬°Correcto! ‚úîÔ∏è`;
        sentenceAdvancedFeedback.classList.remove('hidden', 'feedback-error');
        sentenceAdvancedFeedback.classList.add('feedback-success');
        console.log("[Phase 6 Check] Correct sentence. Advancing.");
        setTimeout(() => {
            currentSentenceIndex_6++;
            displaySentence_6();
        }, 1000);
    } 
    else if (expectedArray.some(text => text.startsWith(typedText))) { 
        sentenceAdvancedFeedback.classList.add('hidden');
    } 
    else { 
        sentenceAdvancedFeedback.textContent = `Incorrecto. ¬°Presta atenci√≥n a MAY√öSCULAS, ACENTOS y PUNTUACI√ìN! ‚ùå`;
        sentenceAdvancedFeedback.classList.remove('hidden', 'feedback-success');
        sentenceAdvancedFeedback.classList.add('feedback-error');
        console.log("[Phase 6 Check] Incorrect sentence.");
    }
}

function handleSentenceEnter_6(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        console.log("[Phase 6] Enter key pressed. Checking sentence input.");
        checkSentenceInput_6();
    }
}

function handleSuperscriptPrevention(e) {
    if (document.activeElement === sentenceInputAdvanced && e.ctrlKey && e.shiftKey && e.key === '=') {
        e.preventDefault();
        console.log("[Superscript Prevention] Prevented browser zoom for Ctrl+Shift+Plus.");
    }
}


        // FASE 7: QUIZ DE ATAJOS DE WORD - NEW PHASE
        const quizQuestions = [
            {
                question: "¬øCu√°l es el atajo de teclado para abrir la ventana de <strong>Fuente</strong> en Microsoft Word?",
                options: ["Ctrl + F", "Ctrl + D", "Ctrl + M", "Ctrl + L"],
                correctAnswer: "Ctrl + M"
            },
            {
                question: "¬øCu√°l es el atajo para aplicar <strong>Cursiva</strong> en Word?",
                options: ["Ctrl + U", "Ctrl + K", "Ctrl + I", "Ctrl + B"],
                correctAnswer: "Ctrl + K" // Using our simulated Ctrl+K for consistency with prior phases
            },
            {
                question: "¬øQu√© atajo usas para <strong>Guardar</strong> un documento en Word?",
                options: ["Ctrl + S", "Ctrl + G", "Ctrl + W", "Ctrl + V"],
                correctAnswer: "Ctrl + S"
            },
            {
                question: "¬øCu√°l es el atajo para <strong>Copiar</strong> texto en Word?",
                options: ["Ctrl + X", "Ctrl + V", "Ctrl + C", "Ctrl + P"],
                correctAnswer: "Ctrl + C"
            },
            {
                question: "¬øQu√© atajo se usa para <strong>Pegar</strong> texto en Word?",
                options: ["Ctrl + P", "Ctrl + X", "Ctrl + C", "Ctrl + V"],
                correctAnswer: "Ctrl + V"
            },
            {
                question: "¬øCu√°l es el atajo para <strong>Cortar</strong> texto en Word?",
                options: ["Ctrl + C", "Ctrl + X", "Ctrl + V", "Ctrl + Z"],
                correctAnswer: "Ctrl + X"
            },
            {
                question: "¬øCu√°l es el atajo para <strong>Deshacer</strong> la √∫ltima acci√≥n en Word?",
                options: ["Ctrl + Y", "Ctrl + Z", "Ctrl + A", "Ctrl + F"],
                correctAnswer: "Ctrl + Z"
            },
            {
                question: "¬øQu√© atajo se usa para <strong>Rehacer</strong> la √∫ltima acci√≥n deshecha?",
                options: ["Ctrl + Z", "Ctrl + R", "Ctrl + Y", "Ctrl + X"],
                correctAnswer: "Ctrl + Y"
            },
            {
                question: "¬øCu√°l es el atajo para <strong>Seleccionar todo</strong> el contenido del documento?",
                options: ["Ctrl + S", "Ctrl + A", "Ctrl + L", "Ctrl + E"],
                correctAnswer: "Ctrl + A"
            }
        ];
        let currentQuizQuestionIndex = 0;
        const quizQuestionElem = document.getElementById('quizQuestion');
        const quizOptionsElem = document.getElementById('quizOptions');
        const quizFeedback = document.getElementById('quizFeedback');

        function startPhase7() {
            console.log("[Phase 7] Starting Quiz...");
            currentQuizQuestionIndex = 0;
            displayQuizQuestion();
            quizFeedback.classList.add('hidden');
        }

        function displayQuizQuestion() {
            if (currentQuizQuestionIndex < quizQuestions.length) {
                const q = quizQuestions[currentQuizQuestionIndex];
                quizQuestionElem.innerHTML = q.question;
                quizOptionsElem.innerHTML = ''; // Clear previous options
                quizFeedback.classList.add('hidden');

                q.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.classList.add('quiz-option-button');
                    button.textContent = option;
                    button.setAttribute('tabindex', 0); // Make button focusable by tab
                    button.setAttribute('data-answer', option); // Store answer for validation
                    button.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault(); // Prevent default button behavior like form submission
                            checkQuizAnswer(option);
                        }
                    });
                    quizOptionsElem.appendChild(button);
                });
                // Focus the first option button for keyboard navigation
                quizOptionsElem.querySelector('.quiz-option-button').focus();
                console.log(`[Phase 7] Displaying Quiz Question: ${q.question}`);
            } else {
                console.log("[Phase 7] Quiz completed. Advancing to end screen.");
                quizQuestionElem.textContent = "¬°Quiz Completado!";
                quizOptionsElem.innerHTML = '';
                quizFeedback.textContent = "¬°Has completado todos los atajos! ‚úîÔ∏è";
                quizFeedback.classList.remove('hidden', 'feedback-error');
                quizFeedback.classList.add('feedback-success');
                nextPhase7Btn.disabled = false;
                autoAdvanceToNextPhase('nextPhase7Btn', '¬°Fase Finalizada! Redirigiendo...', 2000);
            }
        }

        function checkQuizAnswer(selectedAnswer) {
            const correctAnswer = quizQuestions[currentQuizQuestionIndex].correctAnswer;
            console.log(`[Phase 7 Check] Selected: "${selectedAnswer}", Correct: "${correctAnswer}"`);

            const buttons = quizOptionsElem.querySelectorAll('.quiz-option-button');
            buttons.forEach(btn => {
                btn.disabled = true; // Disable all buttons after selection
                if (btn.getAttribute('data-answer') === correctAnswer) {
                    btn.classList.add('correct');
                } else if (btn.getAttribute('data-answer') === selectedAnswer) {
                    btn.classList.add('incorrect');
                }
            });

            if (selectedAnswer === correctAnswer) {
                quizFeedback.textContent = `¬°Correcto! ‚úîÔ∏è`;
                quizFeedback.classList.remove('hidden', 'feedback-error');
                quizFeedback.classList.add('feedback-success');
                console.log("[Phase 7 Check] Correct answer.");
                setTimeout(() => {
                    currentQuizQuestionIndex++;
                    displayQuizQuestion();
                }, 1500); // Short delay before next question
            } else {
                quizFeedback.textContent = `Incorrecto. La respuesta correcta era: ${correctAnswer} ‚ùå`;
                quizFeedback.classList.remove('hidden', 'feedback-success');
                quizFeedback.classList.add('feedback-error');
                console.log("[Phase 7 Check] Incorrect answer.");
                setTimeout(() => {
                    quizFeedback.classList.add('hidden'); // Hide feedback after a delay
                    // Re-enable all buttons for a retry if desired, or auto-advance.
                    // For now, let's just move to next question for simplicity of test flow.
                    currentQuizQuestionIndex++; // Advance even on incorrect, to keep flow
                    displayQuizQuestion();
                }, 2000);
            }
        }


        // Inicializar al cargar la p√°gina
        showPhase(0);
    </script>
</body>
</html>
